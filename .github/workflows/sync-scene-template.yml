name: Sync SDK7 Docs and Scene Template

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  sync-repos:
    runs-on: ubuntu-latest

    steps:
      # Checkout the current repo (not strictly necessary here)
      - name: Checkout current repo
        uses: actions/checkout@v4

      # Set Git user info for future commits
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Clone sdk7-docs (source 1)
      - name: Clone sdk7-docs
        run: git clone --depth 1 https://github.com/drkrillo/dcl-sdk7-docs.git sdk7-docs

      # Clone scene-template (source 2)
      - name: Clone scene-template
        run: git clone --depth 1 https://github.com/decentraland/sdk7-scene-template.git scene-template

      # Clone the destination repo where the final content will be pushed
      - name: Clone destination repo with access token
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: git clone https://x-access-token:${PERSONAL_TOKEN}@github.com/drkrillo/dcl-ai-context.git combined

      # Checkout main branch or create it if it doesn't exist
      - name: Ensure main branch exists
        run: git -C combined checkout main || git -C combined checkout -b main

      # Clean all files in combined except the .git folder
      - name: Clean combined repo contents
        run: find combined -mindepth 1 -not -name '.git' -exec rm -rf {} +

      # Copy sdk7-docs contents to combined (excluding .git)
      - name: Copy sdk7-docs to combined
        run: rsync -av --exclude='.git' sdk7-docs/ combined/

      # Copy scene-template contents to combined (excluding .git)
      - name: Copy scene-template to combined
        run: rsync -av --exclude='.git' scene-template/ combined/

      # Commit and push only if changes exist
      - name: Commit and push if changes
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "ðŸ“‚ Checking inside combined repo..."
          git -C combined status
          git -C combined add .

          if git -C combined diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            echo "ðŸ“¦ Changes found. Committing and pushing..."
            git -C combined commit -m "Auto: Combined update of sdk7-docs and scene-template"
            git -C combined push origin main
          fi
